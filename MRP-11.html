<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Receipt Printer v11</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 100px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: #666;
            margin-bottom: 15px;
        }
        
        .server-status {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
        }
        
        .form-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background: white;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-group input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 5px 0;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        
        .btn-settings {
            background: linear-gradient(45deg, #17a2b8, #6f42c1);
        }
        
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .control-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .control-row:last-child {
            margin-bottom: 0;
        }
        
        .btn-control {
            padding: 10px 20px;
            font-size: 14px;
            white-space: nowrap;
            min-width: 120px;
        }
        
        .preview-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 3px solid #28a745;
            display: none;
        }
        
        .preview-card h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #28a745;
        }
        
        .receipt-preview {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .preview-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .action-buttons {
            display: none;
            margin-top: 20px;
        }
        
        .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .footer-content {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .utility-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .utility-section.show {
            display: block;
        }
        
        .utility-section h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .textarea-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 15px;
        }
        
        .textarea-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 100px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .form-card, .control-panel, .preview-card, .utility-section {
                padding: 20px;
            }
            
            .control-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .preview-actions {
                grid-template-columns: 1fr;
            }
        }
        
        /* Fullscreen Mode Styles */
        .fullscreen-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .fullscreen-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.1);
        }
        
        .fullscreen-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 16px;
            z-index: 2000;
            display: none;
        }
        
        body.fullscreen-active {
            padding: 10px;
        }
        
        body.fullscreen-active .container {
            max-width: none;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- Fullscreen Button -->
    <button class="fullscreen-btn" onclick="toggleFullscreen()" title="Toggle Fullscreen">
        ‚õ∂
    </button>
    <!-- Fullscreen Notification -->
    <div class="fullscreen-notification" id="fullscreenNotification">
        Press F11 or use browser fullscreen to prevent accidental exit
    </div>
    
    <div class="container">
        <!-- Main Form -->
        <div class="form-card" id="inputSection">
            <div class="input-group">
                <label for="biller">Biller Name:</label>
                <input id="biller" list="billerList" required type="text" placeholder="Enter biller name">
                <datalist id="billerList"></datalist>
            </div>

            <div class="input-group">
                <label for="volunteer">Volunteer Name:</label>
                <input id="volunteer" list="volunteerList" required type="text" placeholder="Enter volunteer name">
                <datalist id="volunteerList"></datalist>
            </div>

            <div class="input-group">
                <label for="amount">Amount (Rs.):</label>
                <input id="amount" required type="number" step="0.01" placeholder="0.00">
            </div>

            <button id="createReceiptBtn" onclick="previewReceipt()" class="btn btn-success">
                üìÑ Create Receipt
            </button>

            <div id="actionButtons" class="action-buttons">
                <button onclick="clearFormAndShow()" class="btn btn-secondary">
                    ‚ú® Create New Receipt
                </button>
            </div>
        </div>

        <!-- Receipt Preview -->
        <div id="receiptPreview" class="preview-card">
            <h3>üìÑ Receipt Preview</h3>
            <div id="receiptContent" class="receipt-preview"></div>
            <div class="preview-actions">
                <button onclick="printToBluetoothPrinter()" class="btn btn-success">
                    üñ®Ô∏è Print
                </button>
                <button onclick="shareReceipt()" class="btn btn-settings">
                    üì§ Share
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // GLOBAL VARIABLES
        // ========================================
        
        // Directory handle for File System Access API (stored during session)
        let sessionDirectoryHandle = null;
        // User preference for file saving method
        let useFileSystemAPI = true;
        // PNG save preference key (shared with main page)
        const SAVE_PNG_KEY = 'savePNGEnabled';

        function getSavePNGEnabled() {
            const val = localStorage.getItem(SAVE_PNG_KEY);
            if (val === null) return true; // default ON
            return val === 'true';
        }
        
        // ========================================
        // FULLSCREEN FUNCTIONALITY
        // ========================================
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        }
        
        function enterFullscreen() {
            const docElement = document.documentElement;
            
            if (docElement.requestFullscreen) {
                docElement.requestFullscreen().then(() => {
                    document.body.classList.add('fullscreen-active');
                    showFullscreenNotification();
                });
            } else if (docElement.webkitRequestFullscreen) {
                docElement.webkitRequestFullscreen();
                document.body.classList.add('fullscreen-active');
                showFullscreenNotification();
            } else if (docElement.msRequestFullscreen) {
                docElement.msRequestFullscreen();
                document.body.classList.add('fullscreen-active');
                showFullscreenNotification();
            } else {
                // Fallback for browsers that don't support fullscreen API
                showFullscreenNotification();
            }
        }
        
        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen().then(() => {
                    document.body.classList.remove('fullscreen-active');
                });
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
                document.body.classList.remove('fullscreen-active');
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
                document.body.classList.remove('fullscreen-active');
            }
        }
        
        function showFullscreenNotification() {
            const notification = document.getElementById('fullscreenNotification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Handle fullscreen change events
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                document.body.classList.remove('fullscreen-active');
            }
        });
        
        document.addEventListener('webkitfullscreenchange', () => {
            if (!document.webkitFullscreenElement) {
                document.body.classList.remove('fullscreen-active');
            }
        });
        
        // ========================================
        // CORE DATA MANAGEMENT FUNCTIONS
        // ========================================

        function getStoredNames(key) {
            return JSON.parse(localStorage.getItem(key) || "[]");
        }

        function saveName(key, name) {
            const names = getStoredNames(key);
            if (name && !names.includes(name)) {
                names.push(name);
                localStorage.setItem(key, JSON.stringify(names));
            }
        }

        function populateDatalist(key, datalistId) {
            const names = getStoredNames(key);
            const datalist = document.getElementById(datalistId);
            datalist.innerHTML = names.map(n => `<option value="${n}">`).join('');
        }

        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { hour12: false });
        }

        function getCurrentDate() {
            const now = new Date();
            return now.toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }).replace(/\//g, '-');
        }

        // ========================================
        // FOLDER MANAGEMENT FUNCTIONS
        // ========================================

        async function selectReceiptFolder() {
            if (!('showDirectoryPicker' in window)) {
                alert('üìÅ Folder selection is not supported in this browser.\n\nUsing Downloads folder instead.');
                useFileSystemAPI = false;
                const statusElement = document.getElementById('saveMethodStatus');
                if (statusElement) {
                    statusElement.textContent = 'Downloads Folder';
                }
                return;
            }

            try {
                const dirHandle = await window.showDirectoryPicker({
                    mode: 'readwrite',
                    startIn: 'downloads'
                });

                sessionDirectoryHandle = dirHandle;
                localStorage.setItem('receiptFolderName', dirHandle.name);
                
                // Update status display
                const statusElement = document.getElementById('saveMethodStatus');
                if (statusElement) {
                    statusElement.textContent = `üìÅ ${dirHandle.name}`;
                }
                
                alert(`‚úÖ Folder selected: ${dirHandle.name}\n\nReceipts will be saved here during this session.`);
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error selecting folder:', error);
                    alert('‚ùå Error selecting folder. Using Downloads folder.');
                    useFileSystemAPI = false;
                    const statusElement = document.getElementById('saveMethodStatus');
                    if (statusElement) {
                        statusElement.textContent = 'Downloads Folder';
                    }
                }
            }
        }

        function toggleSaveMethod() {
            useFileSystemAPI = !useFileSystemAPI;
            const status = useFileSystemAPI ? 'Custom Folder' : 'Downloads Folder';
            
            // Update status display
            const statusElement = document.getElementById('saveMethodStatus');
            if (statusElement) {
                statusElement.textContent = status;
            }
            
            alert(`üíæ Save method changed to: ${status}\n\n${useFileSystemAPI ? 'Receipts will be saved to your selected folder.' : 'Receipts will download to your default Downloads folder.'}`);
        }

        function getBillerData(billerName) {
            const data = localStorage.getItem(billerName);
            return data ? JSON.parse(data) : { receipts: [], totalAmount: 0 };
        }

        function saveBillerData(billerName, data) {
            localStorage.setItem(billerName, JSON.stringify(data));
        }

        // ========================================
        // SERVER STATUS FUNCTIONS
        // ========================================

        function updateServerStatus() {
            const serverAddress = localStorage.getItem('serverAddress');
            const statusElement = document.getElementById('serverStatus');
            
            if (serverAddress) {
                statusElement.innerHTML = '‚úÖ Server: Connected';
                statusElement.style.background = '#28a745';
            } else {
                statusElement.innerHTML = '‚ö†Ô∏è Server: Not Set';
                statusElement.style.background = '#ffc107';
            }
        }

        // ========================================
        // RECEIPT GENERATION FUNCTIONS
        // ========================================

        function previewReceipt() {
            const biller = document.getElementById('biller').value.trim();
            const volunteer = document.getElementById('volunteer').value.trim();
            const amount = parseFloat(document.getElementById('amount').value);

            if (!biller || !volunteer || !amount) {
                alert('Please fill in all fields');
                return;
            }

            // Save names for future use
            saveName("billerNames", biller);
            saveName("volunteerNames", volunteer);
            populateDatalist("billerNames", "billerList");
            populateDatalist("volunteerNames", "volunteerList");

            // Generate receipt data
            const billerData = getBillerData(biller);
            const receiptNumber = billerData.receipts.length + 1;
            const receiptData = {
                number: receiptNumber,
                date: getCurrentDate(),
                time: getCurrentTime(),
                volunteer: volunteer,
                amount: amount
            };

            // Save receipt data
            billerData.receipts.push(receiptData);
            billerData.totalAmount = (billerData.totalAmount || 0) + amount;
            saveBillerData(biller, billerData);

            // Create preview text
            const previewText = `Receipt No.: ${receiptNumber}
Biller: ${biller}
Volunteer: ${volunteer}
Amount: Rs. ${amount}`;

            // Show preview
            document.getElementById('receiptContent').textContent = previewText;
            document.getElementById('receiptPreview').style.display = 'block';

            // Generate and save receipt files
            // saveReceiptAsTextFile(receiptData, biller); // Commented out - optional
            if (getSavePNGEnabled()) {
                saveReceiptAsPNG(receiptData, biller);
            }

            // Update UI state
            document.getElementById('biller').disabled = true;
            document.getElementById('volunteer').disabled = true;
            document.getElementById('amount').disabled = true;
            document.getElementById('createReceiptBtn').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'block';

            // Scroll to preview
            document.getElementById('receiptPreview').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
        }

        async function saveReceiptAsTextFile(receiptData, biller) {
            // Create the same receipt format as response.php
            const receiptLines = [
                "=======================",
                `     RECEIPT #${receiptData.number}`,
                "=======================",
                `Date: ${receiptData.date}`,
                `Time: ${receiptData.time}`,
                "-----------------------",
                `Biller: ${biller}`,
                "-----------------------",
                `Volunteer: ${receiptData.volunteer}`,
                "-----------------------",
                `AMOUNT: Rs. ${receiptData.amount}`,
                "======================="
            ];
            
            const receiptText = receiptLines.join('\n');
            
            // Create filename: billername-date-time-receiptnumber.txt
            const safeDate = receiptData.date.replace(/\//g, '-');
            const safeTime = receiptData.time.replace(/:/g, '-');
            const safeBiller = biller.replace(/[^a-zA-Z0-9]/g, '_');
            const filename = `${safeBiller}-${safeDate}-${safeTime}-${receiptData.number}.txt`;
            
            // Try File System Access API if enabled and supported
            if (useFileSystemAPI && 'showDirectoryPicker' in window) {
                try {
                    // Use existing session handle if available
                    let dirHandle = sessionDirectoryHandle;
                    
                    // If no handle, ask user to select folder
                    if (!dirHandle) {
                        dirHandle = await window.showDirectoryPicker({
                            mode: 'readwrite',
                            startIn: 'downloads'
                        });
                        
                        // Store for rest of session
                        sessionDirectoryHandle = dirHandle;
                        localStorage.setItem('receiptFolderName', dirHandle.name);
                    }
                    
                    // Create the file in the selected directory
                    const fileHandle = await dirHandle.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(receiptText);
                    await writable.close();
                    
                    console.log(`Receipt saved to ${dirHandle.name}/${filename}`);
                    return; // Exit early if successful
                    
                } catch (error) {
                    if (error.name === 'AbortError') {
                        // User cancelled, ask if they want to disable File System API
                        if (confirm('‚ùå Folder selection cancelled.\n\nWould you like to switch to regular downloads instead?\n\n(You can change this back later)')) {
                            useFileSystemAPI = false;
                        } else {
                            return; // Don't save if user cancelled and wants to keep trying
                        }
                    } else {
                        console.log('Failed to save to selected folder, falling back to download:', error);
                    }
                    // Fall through to standard download method
                }
            }
            
            // Fallback: Standard download method
            const blob = new Blob([receiptText], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        async function saveReceiptAsPNG(receiptData, biller) {
            // Create canvas optimized for 58mm thermal printer (384px width, 203 DPI)
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas dimensions for 58mm thermal printer
            canvas.width = 384; // 58mm at 203 DPI
            const margin = 16;   // Side margins
            const contentWidth = canvas.width - (margin * 2);
            
            // Set initial height (will adjust based on content)
            canvas.height = 600;
            
            // Set background to white
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Set text properties
            ctx.fillStyle = '#000000';
            ctx.textBaseline = 'top';
            
            // Define receipt lines with formatting (matching response.php)
            const receiptLines = [
                { text: "=======================", bold: false, large: false, center: true },
                { text: `     RECEIPT #${receiptData.number}`, bold: true, large: true, center: true },
                { text: "=======================", bold: false, large: false, center: true },
                { text: `Date: ${receiptData.date}`, bold: false, large: false, center: false },
                { text: `Time: ${receiptData.time}`, bold: false, large: false, center: false },
                { text: "-----------------------", bold: false, large: false, center: true },
                { text: `Biller: ${biller}`, bold: false, large: false, center: false },
                { text: "-----------------------", bold: false, large: false, center: true },
                { text: `Volunteer: ${receiptData.volunteer}`, bold: false, large: false, center: false },
                { text: "-----------------------", bold: false, large: false, center: true },
                { text: `AMOUNT: Rs. ${receiptData.amount}`, bold: true, large: true, center: false },
                { text: "=======================", bold: false, large: false, center: true }
            ];
            
            // Font settings optimized for 58mm thermal printer
            const normalFontSize = 14;
            const largeFontSize = 22;  // Larger for better visibility on thermal printer
            const normalLineHeight = 22;
            const largeLineHeight = 32;
            
            // Draw each line
            let yPos = 16; // Top margin
            
            receiptLines.forEach(line => {
                // Set font based on formatting
                let fontSize = line.large ? largeFontSize : normalFontSize;
                let fontWeight = line.bold ? 'bold' : 'normal';
                ctx.font = `${fontWeight} ${fontSize}px 'Courier New', monospace`;
                
                // Calculate x position for alignment
                let xPos;
                if (line.center) {
                    const textWidth = ctx.measureText(line.text).width;
                    xPos = (canvas.width - textWidth) / 2;
                } else {
                    xPos = margin; // Left margin
                }
                
                // Ensure text fits within canvas width
                if (xPos < margin) xPos = margin;
                if (xPos + ctx.measureText(line.text).width > canvas.width - margin) {
                    // Text is too wide, use smaller font
                    ctx.font = `${fontWeight} ${fontSize - 2}px 'Courier New', monospace`;
                }
                
                // Draw the text
                ctx.fillText(line.text, xPos, yPos);
                
                // Move to next line
                yPos += line.large ? largeLineHeight : normalLineHeight;
            });
            
            // Add bottom margin
            yPos += 16;
            
            // Create final canvas with proper height
            const finalCanvas = document.createElement('canvas');
            const finalCtx = finalCanvas.getContext('2d');
            finalCanvas.width = canvas.width;
            finalCanvas.height = yPos;
            
            // Fill white background
            finalCtx.fillStyle = '#ffffff';
            finalCtx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            // Copy the content
            finalCtx.drawImage(canvas, 0, 0);
            
            // Convert canvas to PNG blob
            return new Promise((resolve) => {
                finalCanvas.toBlob(async (blob) => {
                    // Create filename: billername-date-time-receiptnumber.png
                    const safeDate = receiptData.date.replace(/\//g, '-');
                    const safeTime = receiptData.time.replace(/:/g, '-');
                    const safeBiller = biller.replace(/[^a-zA-Z0-9]/g, '_');
                    const filename = `${safeBiller}-${safeDate}-${safeTime}-${receiptData.number}.png`;
                    
                    // Try File System Access API if enabled and supported
                    if (useFileSystemAPI && 'showDirectoryPicker' in window && sessionDirectoryHandle) {
                        try {
                            // Create the file in the selected directory
                            const fileHandle = await sessionDirectoryHandle.getFileHandle(filename, { create: true });
                            const writable = await fileHandle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            
                            console.log(`Receipt PNG saved to ${sessionDirectoryHandle.name}/${filename}`);
                            resolve();
                            return;
                            
                        } catch (error) {
                            console.log('Failed to save PNG to selected folder, falling back to download:', error);
                            // Fall through to standard download method
                        }
                    }
                    
                    // Fallback: Standard download method
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    resolve();
                }, 'image/png');
            });
        }

        function clearFormAndShow() {
            // Re-enable input fields
            document.getElementById('biller').disabled = false;
            document.getElementById('volunteer').disabled = false;
            document.getElementById('amount').disabled = false;

            // Clear volunteer and amount for next receipt
            document.getElementById('volunteer').value = '';
            document.getElementById('amount').value = '';

            // Hide preview and action buttons
            document.getElementById('receiptPreview').style.display = 'none';
            document.getElementById('actionButtons').style.display = 'none';

            // Show create button
            document.getElementById('createReceiptBtn').style.display = 'block';

            // Focus on volunteer field
            document.getElementById('volunteer').focus();
        }

        // ========================================
        // PRINTING FUNCTIONS
        // ========================================

        function printToBluetoothPrinter() {
            const savedServerAddress = localStorage.getItem('serverAddress');
            const localServerIP = savedServerAddress || "127.0.0.1:8080";
            const previewText = document.getElementById('receiptContent').textContent.split("\n");

            // Extract receipt data
            const receiptNo = previewText[0].split(": ")[1] || '';
            const biller = previewText[1].split(": ")[1] || '';
            const volunteer = previewText[2].split(": ")[1] || '';
            const amount = previewText[3].split(": ")[1].replace("Rs. ", "") || '';

            // Get current date and time for server
            const date = getCurrentDate();
            const time = getCurrentTime();

            // Build API URL
            const params = new URLSearchParams({
                num: receiptNo,
                date: date,
                biller: biller,
                time: time,
                volunteer: volunteer,
                amount: amount
            });

            const responseURL = `http://${localServerIP}/response.php?${params.toString()}`;

            // Determine printer URL scheme based on device
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            let printURL;

            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                printURL = `bprint://${responseURL}`;
            } else {
                printURL = `my.bluetoothprint.scheme://${responseURL}`;
            }

            // Send to printer
            window.location.href = printURL;
        }

        function shareReceipt() {
            const receiptText = document.getElementById('receiptContent').textContent;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Receipt',
                    text: receiptText
                }).catch(err => console.log('Error sharing:', err));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(receiptText).then(() => {
                    alert('Receipt copied to clipboard!');
                }).catch(() => {
                    // Manual copy fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = receiptText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('Receipt copied to clipboard!');
                });
            }
        }

        // ========================================
        // INITIALIZATION
        // ========================================

        document.addEventListener('DOMContentLoaded', function() {
            // Populate name lists
            populateDatalist("billerNames", "billerList");
            populateDatalist("volunteerNames", "volunteerList");
            
            // Update server status
            updateServerStatus();
            
            // Check for test parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('test') === 'true') {
                // Fill form with test data
                document.getElementById('biller').value = 'Test Biller';
                document.getElementById('volunteer').value = 'Test Volunteer';
                document.getElementById('amount').value = '100.00';
                
                // Create receipt preview
                setTimeout(() => {
                    previewReceipt();
                    alert('Test receipt created! You can now print it using the Print button.');
                }, 500);
            } else {
                // Focus on first input for normal use
                document.getElementById('biller').focus();
            }
            
            // Test server connection
            const serverAddress = localStorage.getItem('serverAddress');
            if (serverAddress) {
                fetch(`http://${serverAddress}/response.php`, { method: 'HEAD' })
                    .then(response => {
                        if (response.ok) {
                            const statusElement = document.getElementById('serverStatus');
                            if (statusElement) {
                                statusElement.innerHTML = '‚úÖ Server: Online';
                                statusElement.style.background = '#28a745';
                            }
                        }
                    })
                    .catch(() => {
                        const statusElement = document.getElementById('serverStatus');
                        if (statusElement) {
                            statusElement.innerHTML = '‚ùå Server: Offline';
                            statusElement.style.background = '#dc3545';
                        }
                    });
            }
        });

        // Auto-save form data on input change
        document.getElementById('biller').addEventListener('input', function() {
            if (this.value.trim()) {
                saveName("billerNames", this.value.trim());
                populateDatalist("billerNames", "billerList");
            }
        });

        document.getElementById('volunteer').addEventListener('input', function() {
            if (this.value.trim()) {
                saveName("volunteerNames", this.value.trim());
                populateDatalist("volunteerNames", "volunteerList");
            }
        });

        // Enter key shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                if (document.getElementById('createReceiptBtn').style.display !== 'none') {
                    previewReceipt();
                }
            }
        });
    </script>
</body>
</html>